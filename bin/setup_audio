#!/bin/bash
# setup_audio - One command to fix audio on Void Linux (FIXED VERSION)

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${GREEN}[*]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[x]${NC} $1" >&2; }
section() { echo -e "\n${BLUE}[â–¶]${NC} $1"; }

section "Setting up PipeWire/WirePlumber on Void Linux..."

# Check if running on Void
if [ ! -f "/etc/void-release" ]; then
    warn "This script is designed for Void Linux. Continuing anyway..."
fi

# =============================================================================
# 1. INSTALL PACKAGES
# =============================================================================
section "Installing packages..."

sudo xbps-install -Sy \
    pipewire \
    wireplumber \
    alsa-pipewire \
    pavucontrol \
    pamixer \
    libspa-bluetooth \
    bluez \
    blueman \
    || warn "Some packages may already be installed"


# 2 
section "Configuring user PipeWire directory..."
mkdir -p "$HOME/.config/pipewire/pipewire.conf.d"

ln -sf /usr/share/examples/wireplumber/10-wireplumber.conf \
  "$HOME/.config/pipewire/pipewire.conf.d/"

ln -sf /usr/share/examples/pipewire/20-pipewire-pulse.conf \
  "$HOME/.config/pipewire/pipewire.conf.d/"

# i don't know is it required or not
mkdir -p /etc/alsa/conf.d
sudo ln -s /etc/alsa/conf.d/50-pipewire.conf /etc/alsa/conf.d
sudo ln -s /etc/alsa/conf.d/99-pipewire-default.conf /etc/alsa/conf.d


# =============================================================================
# 5. ENABLE SERVICES
# =============================================================================
section "Enabling bluetoothd services..."

# Enable Bluetooth daemon
if [ ! -L /var/service/bluetoothd ]; then
    sudo ln -sf /etc/sv/bluetoothd /var/service/
    info "Enabled bluetoothd service"
else
    info "bluetoothd already enabled"
fi


# =============================================================================
# 6. USER GROUPS
# =============================================================================
section "Configuring user permissions..."

# Add to audio group
if ! groups "$USER" | grep -q "\baudio\b"; then
    sudo usermod -aG audio "$USER"
    warn "Added to 'audio' group. Logout and login required for this to take effect."
fi

# Add to bluetooth group
if ! groups "$USER" | grep -q "\bbluetooth\b"; then
    sudo usermod -aG bluetooth "$USER"
    warn "Added to 'bluetooth' group."
fi


info "Bluetooth devices:"
bluetoothctl list 2>/dev/null || warn "No Bluetooth controller found or bluetoothd not ready"

section "Restarting PipeWire | wireplumber..."

pkill pipewire || true
pkill wireplumber || true
section "Setup complete!"
